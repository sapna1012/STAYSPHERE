<% layout("layouts/boilerplate") %>

<div class="container mt-4">

  <!-- Search Bar + GST Toggle -->
  <div class="row mb-4">
    <div class="col-12">
      <form method="GET" action="/listings" class="d-flex flex-wrap justify-content-center gap-3">

        <!-- Search input + button -->
        <div class="input-group search-bar flex-grow-1">
          <input
            type="text"
            name="search"
            class="form-control"
            placeholder="Search by location or title"
            value="<%= typeof search !== 'undefined' ? search : '' %>"
          />
          <% if(category){ %>
            <input type="hidden" name="category" value="<%= category %>"/>
          <% } %>
          <button class="btn btn-dark" type="submit">Search</button>
        </div>

        <!-- Airbnb-style GST Toggle -->
        <div class="airbnb-toggle">
          <input type="checkbox" id="taxSwitch" />
          <label for="taxSwitch">
            <span></span>
            <small>GST</small>
          </label>
        </div>

      </form>
    </div>
  </div>

  <!-- Category Filters -->
  <div id="filters" class="d-flex flex-wrap gap-3 mb-4 justify-content-center text-center">
    <% const categories = [
      {name:'All', icon:'fa-earth-americas'},
      {name:'Trending', icon:'fa-fire'},
      {name:'Rooms', icon:'fa-bed'},
      {name:'Iconic Cities', icon:'fa-city'},
      {name:'Mountains', icon:'fa-mountain'},
      {name:'Castles', icon:'fa-fort-awesome'},
      {name:'Amazing Pools', icon:'fa-person-swimming'},
      {name:'Camping', icon:'fa-campground'},
      {name:'Farms', icon:'fa-tractor'},
      {name:'Arctic', icon:'fa-snowflake'},
      {name:'Deserts', icon:'fa-sun'}
    ] %>

    <% categories.forEach(cat => { 
      let queryString = '?';
      if(search) queryString += 'search=' + encodeURIComponent(search) + '&';
      if(cat.name !== 'All') queryString += 'category=' + encodeURIComponent(cat.name);
    %>
      <a href="/listings<%= queryString %>" class="filter text-center <%= (cat.name===category || (!category && cat.name==='All')) ? 'active-filter' : '' %>">
        <i class="fa-solid <%= cat.icon %>"></i>
        <p><%= cat.name %></p>
      </a>
    <% }) %>
  </div>

  <!-- Listings Grid -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
    <% allListings.forEach(listing => { %>
      <div class="col">
        <div class="card listing-card h-100 shadow-sm">
          <img 
            src="<%= listing.image && listing.image.url ? listing.image.url.replace('/upload', '/upload/w_600,h_400,c_fill') : 'https://res.cloudinary.com/demo/image/upload/sample.jpg' %>" 
            class="card-img-top" 
            alt="Listing Image" 
            style="height:16rem; object-fit:cover;"
          />
          <div class="card-body">
            <h5 class="card-title"><%= listing.title %></h5>
            <p class="card-text text-muted"><%= listing.location %>, <%= listing.country %></p>
            <p class="card-text fw-bold">
              ₹ <span class="base-price"><%= listing.price.toLocaleString("en-IN") %></span>
              <span class="tax-info text-success" style="display:none;">
                ₹ <%= (listing.price*1.18).toLocaleString("en-IN") %> (incl. GST)
              </span>
            </p>
            <a href="/listings/<%= listing._id %>" class="btn btn-dark btn-sm">View</a>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

</div>

<!-- Script for GST Toggle -->
<script>
  const taxSwitch = document.getElementById('taxSwitch');
  const taxInfoElements = document.querySelectorAll('.tax-info');

  taxSwitch.addEventListener('change', () => {
    taxInfoElements.forEach(el => {
      el.style.display = taxSwitch.checked ? 'inline' : 'none';
    });
  });
</script>

<style>
/* Search Bar */
.search-bar {
  max-width: 500px;
  margin: 0 auto;
}
.search-bar input {
  border-radius: 50px 0 0 50px !important;
  padding: 0.6rem 1.2rem;
  text-align: center;
}
.search-bar input::placeholder {
  text-align: center;
  color: #888;
}
.search-bar button {
  border-radius: 0 50px 50px 0 !important;
  padding: 0.6rem 1.2rem;
  font-size: 0.95rem;
  font-weight: 500;
}

/* Category Filters */
#filters .filter {
  opacity: 0.6;
  text-decoration: none;
  color: inherit;
  padding: 0.3rem 0.8rem;
  border-radius: 8px;
  transition: all 0.2s;
  display: flex; 
  flex-direction: column; 
  align-items: center;
}
#filters .filter:hover,
#filters .active-filter {
  opacity: 1;
  border-bottom: 2px solid black;
}
#filters p {
  font-size: 0.8rem;
  margin-top: 0.2rem;
}

/* Airbnb-style Toggle */
.airbnb-toggle {
  display: flex;
  align-items: center;
}
.airbnb-toggle input { display: none; }
.airbnb-toggle label {
  display: flex;
  align-items: center;
  cursor: pointer;
}
.airbnb-toggle label span {
  width: 40px;
  height: 20px;
  background: #ccc;
  border-radius: 999px;
  position: relative;
  transition: background 0.3s;
  margin-right: 0.5rem;
}
.airbnb-toggle label span::before {
  content: "";
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s;
}
.airbnb-toggle input:checked + label span { background: #ff385c; }
.airbnb-toggle input:checked + label span::before { transform: translateX(20px); }
.airbnb-toggle label small { font-size: 0.8rem; color: #555; }

/* ✅ Responsive Tweaks */
@media (max-width: 576px) {
  .search-bar {
    max-width: 100%;
    flex: 1 1 100%;
  }
  .search-bar input {
    font-size: 0.9rem;
  }
  #filters {
    gap: 1rem;
  }
  #filters p {
    font-size: 0.7rem;
  }
}
</style>
